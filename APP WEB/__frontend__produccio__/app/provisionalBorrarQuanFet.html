<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Acceder a Gmail y Descargar PDFs</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

  <h2>Descarga automática de PDFs desde Gmail</h2>
  <button onclick="handleAuthClick()">Iniciar sesión con Google</button>

  <script>
    const CLIENT_ID = '246049552174-fqcrsh2uvcpouptn1tij8t7bh686h4ad.apps.googleusercontent.com';  // <-- HEM AFEGIT EL CLIENT ID!
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly'; // <-- el mateix scope definit a la API (el read only que diu que nomes pot llegir gmails)

    function handleAuthClick() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: "", /*la api key no es necessària per al nostre cas*/
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
        }).then(() => {
          const authInstance = gapi.auth2.getAuthInstance();
          if (!authInstance.isSignedIn.get()) {
            authInstance.signIn().then(listMessages);
          } else {
            listMessages();
          }
        });
      });
    }

    function listMessages() {
      const query = 'subject:Factura filename:pdf'; // Ajusta esto a tus necesidades
      gapi.client.gmail.users.messages.list({
        userId: 'me',
        q: query
      }).then(res => {
        const messages = res.result.messages || [];
        if (messages.length === 0) {
          alert("No se encontraron correos con ese asunto.");
          return;
        }
        messages.forEach(msg => downloadPDFsFromMessage(msg.id));
      });
    }

    function downloadPDFsFromMessage(messageId) {
      gapi.client.gmail.users.messages.get({
        userId: 'me',
        id: messageId
      }).then(res => {
        const parts = res.result.payload.parts || [];
        parts.forEach(part => {
          if (part.filename && part.filename.endsWith('.pdf')) {
            const attachmentId = part.body.attachmentId;
            const filename = part.filename;
            gapi.client.gmail.users.messages.attachments.get({
              userId: 'me',
              messageId: messageId,
              id: attachmentId
            }).then(attachment => {
              const data = attachment.result.data;
              const byteCharacters = atob(data);
              const byteArray = new Uint8Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteArray[i] = byteCharacters.charCodeAt(i);
              }
              const blob = new Blob([byteArray], {type: 'application/pdf'});
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = filename;
              link.click();
            });
          }
        });
      });
    }
  </script>

</body>
</html>
